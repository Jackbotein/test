<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" type="text/css" href="style.css">
  <div class="bk-store-locator">
<div class="sl-cols-wrapper">
      <aside class="results-col">
        <form action="#" method="post" class="sl-search">
        <span class="input-wrapper">
          <input type="text" placeholder="Rechercher une agence">
        </span>
        </form>
        <div class="sl-results-wrapper custom-scroll">
          <!-- -->
          <script type="text/template" id="template-agencies-list">
            <li>
              <div class="bk-card-store">
                <h2 class="cs-title"></h2>
                <address class="cs-address"></address>
                <div class="cs-tel"><a href=""></a></div>
                <div class="cs-link"><a href="">Consulter la page</a></div>
              </div>
            </li>
            <!-- -->
          </script>
          <ul><!-- Pour le SEO la liste doit $etre remplie au chargement -->
            <li>
              <div class="bk-card-store">
                <h2 class="cs-title">Agence Nord ouest</h2>
                <address class="cs-address">5 / 7 rue du petit Albi 95000 Cergy</address>
                <div class="cs-tel"><a href="tel:+33 (0)1 81 84 56 32">+33 (0)1 81 84 56 32</a></div>
                <div class="cs-link"><a href="agence.html">Consulter la page</a></div>
              </div>
            </li>
            <!-- -->
            <li>
              <div class="bk-card-store">
                <h2 class="cs-title">Agence Nord ouest</h2>
                <address class="cs-address">5 / 7 rue du petit Albi 95000 Cergy</address>
                <div class="cs-tel"><a href="tel:+33 (0)1 81 84 56 32">+33 (0)1 81 84 56 32</a></div>
                <div class="cs-link"><a href="agence.html">Consulter la page</a></div>
              </div>
            </li>
            <!-- -->
            <li>
              <div class="bk-card-store">
                <h2 class="cs-title">Agence Nord ouest</h2>
                <address class="cs-address">5 / 7 rue du petit Albi 95000 Cergy</address>
                <div class="cs-tel"><a href="tel:+33 (0)1 81 84 56 32">+33 (0)1 81 84 56 32</a></div>
                <div class="cs-link"><a href="agence.html">Consulter la page</a></div>
              </div>
            </li>
            <!-- -->
            <li>
              <div class="bk-card-store">
                <h2 class="cs-title">Agence Nord ouest</h2>
                <address class="cs-address">5 / 7 rue du petit Albi 95000 Cergy</address>
                <div class="cs-tel"><a href="tel:+33 (0)1 81 84 56 32">+33 (0)1 81 84 56 32</a></div>
                <div class="cs-link"><a href="agence.html">Consulter la page</a></div>
              </div>
            </li>
            <!-- -->
            <li>
              <div class="bk-card-store">
                <h2 class="cs-title">Agence Nord ouest</h2>
                <address class="cs-address">5 / 7 rue du petit Albi 95000 Cergy</address>
                <div class="cs-tel"><a href="tel:+33 (0)1 81 84 56 32">+33 (0)1 81 84 56 32</a></div>
                <div class="cs-link"><a href="agence.html">Consulter la page</a></div>
              </div>
            </li>
            <!-- -->
          </ul>
        </div>
      </aside>
      <!-- -->
      <div class="map-col">
        <div class="sl-map-wrapper" id="sl-map"></div>
  </head>
  <body>
    <script>
          function initMap() {
            window.mapAgencies = new google.maps.Map(document.getElementById('sl-map'), {
              center: new google.maps.LatLng(48.871982, 2.291425),
              zoom: 12,
              maxZoom: 18,
              disableDefaultUI: false
            });

            var infowindow = new google.maps.InfoWindow();

            var bounds = new google.maps.LatLngBounds();

            // Center change
            google.maps.event.addListener(window.mapAgencies, 'dragend', function() {
              oldCenter = window.mapAgencies.getCenter();
            });

            //Center map
            google.maps.event.addDomListener(window, 'resize', function() {
              window.mapAgencies.setCenter(oldCenter);
              oldCenter = window.mapAgencies.getCenter();
            });

            $(function() { // Document ready
              var jsonDatas = [
                {
                  "title": "Agence Nord Ouest",
                  "address": "83 Boulevard Poissonnière 75002 Paris",
                  "lat": "48.870476",
                  "lng": "2.347683",
                  "tel": "+33 (0)1 81 84 56 32",
                  "link": "#"
                },
                {
                  "title": "Agence Nord Est",
                  "address": "Boulevard Carry 750020 Paris",
                  "lat": "48.864576",
                  "lng": "2.403977",
                  "tel": "+33 (0)1 81 84 56 34",
                  "link": "#"
                },
                {
                  "title": "Agence Bordeaux",
                  "address": "9 Allée James Watt 33300 Mérignac",
                  "lat": "44.796676",
                  "lng": "-0.603427",
                  "tel": "+33 (0)1 81 84 56 31",
                  "link": "#"
                },
                {
                  "title": "Agence Montpellier",
                  "address": "48 Rue Claude Balbastre, 34070 Montpellier",
                  "lat": "43.611569",
                  "lng": "3.915282",
                  "tel": "+33 (0)1 81 84 56 30",
                  "link": "#"
                }
              ];
              
              setMapAndList(jsonDatas);
              
              $('.sl-search input').on('keyup', filterResults);

              $('.sl-map-wrapper').on('mouseover', function () {
                $('input:focus').blur();
              });

            });

            var textContents = [];
            var matchesContents = [];

            function filterResults (e) {
              $obj = $(e.currentTarget);
              searchString = $obj.val().toLowerCase();

              matchesContents = [];

              $.each(textContents, function(index, content) {
                if (searchString == '') { // IF input search not empty
                  matchesContents.push(1);
                } else { // IF input search not empty
                  if (content.indexOf(searchString) !== -1) {
                    matchesContents.push(1);
                  } else {
                    matchesContents.push(0);
                  }
                }
              });

              //console.log(matchesContents);

              $.each(window.markers, function (index, marker) {
                if (matchesContents[index] == 0) {
                  marker.setVisible(false);
                  $('.sl-results-wrapper ul li').eq(index).addClass('hidden');
                } else {
                  marker.setVisible(true);
                  $('.sl-results-wrapper ul li').eq(index).removeClass('hidden');
                }
                //window.markerclusterer.repaint();

                fitBoundsToVisibleMarkers();
              });

            }

            function fitBoundsToVisibleMarkers() {

              var bounds = new google.maps.LatLngBounds();

              $.each(window.markers, function (index, marker) {
                if(marker.getVisible()) {
                  bounds.extend( marker.getPosition() );
                }
              });

              window.mapAgencies.fitBounds(bounds);

            }

            function setMapAndList (agencies){

              var icon = {
                path: "M23.5,0C11.3,0,0.2,9.9,0.2,22.2C0.2,34.4,10.3,49,23.5,70c13.2-21,23.3-35.6,23.3-47.8C46.8,9.9,35.7,0,23.5,0z M23.5,32.1c-4.8,0-8.7-3.9-8.7-8.8c0-4.8,3.9-8.8,8.7-8.8c4.8,0,8.7,3.9,8.7,8.8C32.2,28.2,28.3,32.1,23.5,32.1z",
                fillColor: '#f8ac00',
                fillOpacity: 1,
                anchor: new google.maps.Point(28, 70),
                strokeWeight: 0,
                scale: 0.8
              };

              //reset markers
              window.markers = [];
              window.markerclusterer = new MarkerClusterer(
                window.mapAgencies,
                window.markers,
                {
                  imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m',
                  clusterClass: 'custom-clustericon',
                  ignoreHidden: true
                }
              );
              //window.markerclusterer.setIgnoreHidden(true);
              $('.sl-results-wrapper ul').html('');

              $.each(agencies, function (index, agence) {

                var agence = agence;
                var title = agence.title;
                var address = agence.address;
                var tel = agence.tel;
                var link = agence.link;
                var lat = agence.lat;
                var lng = agence.lng;

                var $html = $($('#template-agencies-list').html());
                $html.find('.cs-title').html(title);
                $html.find('.cs-address').html(address);
                $html.find('.cs-tel a').html(tel).attr('href', 'tel:'+tel);
                $html.find('.cs-link a').attr('href', link);

                textContents.push($html.text().toLowerCase());

                marker = new google.maps.Marker({
                  position: new google.maps.LatLng(lat, lng),
                  icon: icon,
                  map: window.mapAgencies
                });

                window.markers.push(marker);

                bounds.extend(marker.position);

                google.maps.event.addListener(marker, 'click', (function (marker, index) {
                  return function () {
                    infowindow.setContent($html.html());
                    infowindow.open(window.mapAgencies, marker);
                  }
                })(marker, index));

                google.maps.event.addListener(marker, 'visible_changed', function(){
                  //console.log('marker '+index+' change detat :', marker.getVisible());
                  if ( marker.getVisible() ) {
                    window.markerclusterer.addMarker(marker, false);
                    window.markerclusterer.repaint();
                  } else {
                    window.markerclusterer.removeMarker(marker, false);
                    window.markerclusterer.repaint();
                  }
                });

                //
                $('.sl-results-wrapper ul').append($html)
                window.markerclusterer.addMarkers(window.markers, true);

              });

              //console.log(textContents);

              window.mapAgencies.fitBounds(bounds);

              var oldCenter = window.mapAgencies.getCenter();
            }
          }
        </script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/markerclustererplus/2.1.4/markerclusterer.js"></script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAILGVlt-SOiL381JT3TQ9dxxoNIUuxrV8&callback=initMap" async defer></script>

      </div>
    </div>
  </div>
</body>
</html>
